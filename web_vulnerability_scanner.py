#!/home/stars/projects/.env/bin/python3
from web_scraping import get_input_forms
from proxy import get_proxies
from fake_headers import Headers
from threading import Thread
from itertools import cycle
import requests,os,time,sys

def version():
    colour = '\033[3m \033[38;5;21m'
    ENDC = '\033[0m'
    print(colour+"\n ________  _______   _______   ________      "+ENDC)
    print(colour+r"|\   __  \|\  ___ \ |\  ___ \ |\   ____\     "+ENDC)
    print(colour+r"\ \  \|\ /\ \   __/|\ \   __/|\ \  \___|_    "+ENDC)
    print(colour+r"\ \   __  \ \  \_|/_\ \  \_|/_\ \_____  \     "+ENDC)
    print(colour+r"  \ \  \|\  \ \  \_|\ \ \  \_|\ \|____|\  \  "+ENDC)
    print(colour+r"   \ \_______\ \_______\ \_______\____\_\  \ "+ENDC)
    print(colour+r"    \|_______|\|_______|\|_______|\_________\ "+ENDC)
    print(colour+r"                                 \|_________|"+ENDC)
    print(colour+"\nThis tool is to find the common vulnerabilities in website\n"+ENDC)
    print(colour+"Bees v1"+ENDC)
    print(colour+"version 1.1\n"+ENDC)

def print_help():
    colour = '\033[3m \033[38;5;23m'
    ENDC = '\033[0m'
    print(colour+"\nUsage: Bees https://example.com -flag or Bees https://example.com -flag -flag\n"+ENDC)
    print(colour+"flag -cmd  : scan for command injection"+ENDC)
    print(colour+"flag -ssrf : scan for SSRF vulnerability"+ENDC)
    print(colour+"flag -xss  : scan for XSS vulnerability"+ENDC)
    print(colour+"flag -sql  : scan for SQL injection"+ENDC)
    print(colour+"flag -dir  : scan for directory traversal"+ENDC)
    print(colour+"flag --full: scan for all common vulnerabilities"+ENDC)
    print(colour+"flag --live : watch the attack process in live in terminal"+ENDC)
    print(colour+"flage --file : store the attack results in a file named results.txt for later analyisis\n"+ENDC)
    
def user_input():
    #get the input from the command line check the user input length
    #if the length is less than excepted then exit the code and say the user how to use it
    colour = '\033[3m \033[38;5;23m'
    ENDC = '\033[0m'
    if len(sys.argv) < 2:
        print(colour+"\nUsage: Bees <url> -flag(s)\nUse -h or --help for help, -v or --version for version"+ENDC)
        sys.exit(0)

    # Handle help/version flags first
    if sys.argv[1] in ['-h', '--help']:
        print_help()

    elif sys.argv[1] in ['-v', '--version']:
        version()
        sys.exit(0)

    # Now enforce URL + flags
    if len(sys.argv) < 4:
        print(colour+"\nUsage: Bees <url> -flag(s)\nUse -h or --help for help, -v or --version for version"+ENDC)
        sys.exit(0)
    else:
        version()
        url = sys.argv[1]
        return url
#getting the palyods from the file and loading it into the list
def sql_payload():
    sql_payloads = []
    with open ('sql.txt','r') as f:
        for payload in f:
            sql_payloads.append(payload.strip())
        return sql_payloads

def xss_payload():
    xss_payloads = []
    with open ('xss.txt','r') as f:
        for payload in f:
            xss_payloads.append(payload.strip())
        return xss_payloads

def ssrf_payload():
    ssrf_payloads = []
    with open ('ssrf.txt','r') as f:
        for payload in f:
            ssrf_payloads.append(payload.strip())
        return ssrf_payloads

def cmd_payload():
    cmd_payloads = []
    with open ('cmd.txt','r') as f:
        for payload in f:
            cmd_payloads.append(payload.strip())
        return cmd_payloads

def dir_payload():
    dir_payloads = []
    with open ('dir.txt','r') as f:
        for payload in f:
            dir_payloads.append(payload.strip())
        return dir_payloads

def generate_fake_headers():
    #generate fake headers and return it
    headers = Headers(headers=True).generate()
    return headers

def read_proxies():
    #get_porxies function gets the proxyies need to send the request to the site to avoid blocking ip
    #checking the file is empty if empty wait for 6 sesonds 
    file_is_empty = False
    result = get_proxies()
    proxies = []
    with open("proxy.txt","r") as f:

        if os.stat('proxy.txt').st_size != 0:
            if result == 1:
                for proxy in f:
                    proxy.strip()
                    protocol = proxy.split(":")[0]
                    proxies.append({protocol:proxy})
                return proxies
            else:
                for proxy in f:
                    proxy.strip()
                    protocol = proxy.split(":")[0]
                    proxies.append({protocol:proxy})
                return proxies
        else:
            #checking is the file is empty or not if empty sleep for 6 seconds
            if file_is_empty is True:
                sys.exit(1)
            else:
                file_is_empty = True
                time.sleep(6)

def response_handler(response,endpoint,payload):
    colour = '\033[3m \033[38;5;21m'
    ENDC = '\033[0m'
    colour_lines = '\033[3m \033[31;5;26m'
    #checking the status code and of the web response for the payload
    #checking the user flag input for live output and storeing the output in a file
    if response.status_code in [200,204,301,500,302]:
        if sys.argv[3] == '--live':
            
            print(colour_lines+'>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>'+ENDC)
            print(colour_lines+'<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<'+ENDC)
            print(colour +f"""\n==> Endpoint: {endpoint} 
            ==> vulnerable to the payload: {payload}
            ==> response:\t{response.text}\n\n""" + ENDC)
        elif sys.argv[3] == 'file':
           
            with open ('results.txt','a') as f:
                f.write('>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>')
                f.write('<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\n')
                f.write(f"""==> Endpoint: {endpoint}
                ==> vulnerable to the payload: {payload}
                ==> response:\t{response.text}\n\n""")
        else:
            print_help()

def send_request(url,proxy,endpoint,method,action):

    #loop through all the endpoints in the website to check all the endpoints in a site
    session = requests.Session()
    payloads = []
    time.sleep(8)
    header = generate_fake_headers()
    print(endpoint,method,action)
        #wait for two second before sending the request to prevent from dos
    try:
            #checking the user input flag which type of scan user wanted to do
        sql_payloads =sql_payload()
        cmd_payloads = cmd_payload()
        ssrf_payloads = ssrf_payload()
        xss_payloads = xss_payload()
        dir_payloads = dir_payload()
        if method == None:
            pass
        else:
            if sys.argv[2] == '--full': 
                #checking the methods and actions and modifiing the payloads accoriding to the action
                if method == 'post' and action == 'login':
                
                    payloads = sql_payloads+cmd_payloads+xss_payloads
                    for payload in payloads:
                        data = {"username": payload, "password": "Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()

                elif method == 'post' and action == 'signup' or action == 'sigin':
                    payloads = sql_payloads+cmd_payloads+xss_payloads
                    
                    for payload in payloads:
                        data = {"username":payload,"email":"example@gmail.com","password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'post' and action not in ['sigin','signup','login']:
                    payloads = sql_payloads+cmd_payloads+xss_payloads
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'get':
                    payloads = sql_payloads+cmd_payloads+xss_payloads+dir_payloads+ssrf_payloads
                    for payload in payloads:
                        response = session.get(endpoint,proxies=proxy,headers=header,params={"q":payload})
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'put' and action in ['sigin','sigup']:
                    payloads = sql_payloads+cmd_payloads+xss_payloads
                    
                    for payload in payloads:
                        data = {"username":payload,"email":"example@gmail.com","password":"Test@123:"}
                        response = session.put(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()
                
                elif method == 'put' and action == 'login':
                
                    payloads = sql_payloads+cmd_payloads+xss_payloads
                    for payload in payloads:
                        data = {"username":payload,"password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                
                elif method == 'put' and action not in ['login','sigin','sigup']:
                    payloads = sql_payloads+cmd_payloads+xss_payloads
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                    #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                else:
                    sys.exit(1)
                print("[+] No vulnerabilities foundðŸ³")
            elif sys.argv[2] == '-sql':
                if method == 'post' and action in ['sigin','signup']:
                    payloads.append(sql_payloads)
                    for payload in payloads:
                        data = {"username":payload,"email":"example@gmail.com","password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'post' and action == 'login':
                    payloads.append(sql_payloads)
                    for payload in payloads:
                        data = {"username":payload,"password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'post' and action not in ['sigin','signup','login']:
                    payloads.append(sql_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'get':
                    payloads.append(sql_payloads)
                    for payload in payloads:
                        response = session.get(endpoint,proxies=proxy,headers=header,params={"q":payload})
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'put' and action in ['sigin','sigup']:
                    payloads.append(sql_payloads)
                    for payload in payloads:
                        data = {"username":payload,"email":"example@gmail.com","password":"Test@123:"}
                        response = session.put(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()
                
                elif method == 'put' and action == 'login':
                
                    payloads.append(sql_payload)
                    for payload in payloads:
                        data = {"username":payload,"password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                
                elif method == 'put' and action not in ['login','sigin','sigup']:
                    payloads.append(sql_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                    #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                else:
                    sys.exit(1)
                print("[+] No sql injuction vulnerabilities foundðŸ³")
            elif sys.argv[2] == '-cmd':
                if method == 'post' and action in ['sigin','signup']:
                    payloads.append(cmd_payloads)
                    for payload in payloads:
                        data = {"username":payload,"email":"example@gmail.com","password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'post' and action == 'login':
                    payloads.append(cmd_payloads)
                    for payload in payloads:
                        data = {"username":payload,"password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'post' and action not in ['sigin','signup','login']:
                    payloads.append(cmd_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'get':
                    payloads.append(cmd_payloads)
                    for payload in payloads:
                        response = session.get(endpoint,proxies=proxy,headers=header,params={"q":payload})
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'put' and action in ['sigin','sigup']:
                    payloads.append(cmd_payloads)
                    for payload in payloads:
                        data = {"username":payload,"email":"example@gmail.com","password":"Test@123:"}
                        response = session.put(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()
                
                elif method == 'put' and action == 'login':
                
                    payloads.append(cmd_payload)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                
                elif method == 'put' and action not in ['login','sigin','sigup']:
                    payloads.append(cmd_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                        #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                else:
                    sys.exit(1)
                print("[+] No cmd injuction vulnerabilities foundðŸ³")
            elif sys.argv[2] == '-xss':
                if method == 'post' and action in ['sigin','signup']:
                    payloads.append(xss_payloads)
                    for payload in payloads:
                        data = {"username":payload,"email":"example@gmail.com","password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'post' and action == 'login':
                    payloads.append(xss_payloads)
                    for payload in payloads:
                        data = {"username":payload,"password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'post' and action not in ['sigin','signup','login']:
                    payloads.append(xss_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'get':
                    payloads.append(xss_payloads)
                    for payload in payloads:
                        response = session.get(endpoint,proxies=proxy,headers=header,params={"q":payload})
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'put' and action in ['sigin','sigup']:
                    payloads.append(xss_payloads)
                    for payload in payloads:
                        data = {"username":payload,"email":"example@gmail.com","password":"Test@123:"}
                        response = session.put(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    payloads.clear()
                
                elif method == 'put' and action == 'login':
                
                    payloads.append(xss_payloads)
                    for payload in payloads:
                        data = {"username":payload,"password":"Test@123:"}
                        response = session.post(endpoint,proxies=proxy,headers=header,data=data)
                        response_handler(response,endpoint,payload)
                    #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                
                elif method == 'put' and action not in ['login','sigin','sigup']:
                    payloads.append(xss_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                        #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                else:
                    sys.exit(1)
                print("[+] No xss vulnerabilities foundðŸ³")
            elif sys.argv[2] == '-dir':
                if method == 'post' and action not in ['sigin','signup','login']:
                    payloads.append(dir_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'get':
                    payloads.append(dir_payloads)
                    for payload in payloads:
                        response = session.get(endpoint,proxies=proxy,headers=header,params={"q":payload})
                        response_handler(response,endpoint,payload)
                    payloads.clear()
                
                elif method == 'put' and action not in ['login','sigin','sigup']:
                    payloads.append(dir_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                        #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                else:
                    sys.exit(1)
                print("[+] No directory traversal vulnerabilities foundðŸ³")
            elif sys.argv[2] == '-ssrf':
                if method == 'post' and action not in ['sigin','signup','login']:
                    payloads.append(ssrf_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                    payloads.clear()

                elif method == 'get':
                    payloads.append(ssrf_payloads)
                    for payload in payloads:
                        response = session.get(endpoint,proxies=proxy,headers=header,params={"q":payload})
                        response_handler(response,endpoint,payload)
                    payloads.clear()
                
                elif method == 'put' and action not in ['login','sigin','sigup']:
                    payloads.append(ssrf_payloads)
                    for payload in payloads:
                        response = session.post(endpoint,proxies=proxy,headers=header,data=payload)
                        response_handler(response,endpoint,payload)
                        #clearing the list after the scan for avoiding duplicate payloads
                    payloads.clear()
                else:
                    sys.exit(1)
            else:
                print_help()
            print("[+] No ssrf vulnerabilities foundðŸ³")
    except Exception as e:
        print(f"Check the url is correct {endpoint}: ", e)

def main():
    try:
        url = user_input()
        proxies = read_proxies()
        proxy = cycle(proxies)
        #cycle the proxies to make the all the request send through the proxies
        colour = '\033[1m \033[92m'
        ENDC = '\033[0m'
        print(colour+f"[+] Crawling website, please wait ...>>>"+ENDC)
        forms = get_input_forms(url)
        print(colour+f"[+] Crawl Finished ...>>>\n"+ENDC)
        print(colour+f"[+] Scanning for vulnerability ...>>>\n"+ENDC)
        for form in forms:
            print(form)
            endpoint = form['page']
            method =  form['method']
            action = form['action']
            send_request(url,next(proxy),endpoint,method,action)
            print(endpoint,method,action)
    except KeyboardInterrupt:
        sys.exit(0)

if __name__ == "__main__":
    main()
    